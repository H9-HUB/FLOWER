<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>收货地址 - Floral Dreams</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="css/style.css" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <style>
    .empty{background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:2rem;text-align:center;color:#666}
    .addr-card{padding:1rem}
    /* 使用统一按钮样式，避免与其他界面不一致 */
  </style>
</head>
<body class="page-address">
  <!-- 统一导航由 js/common.js 注入 -->
  <div class="address-shell container py-4">
    <div class="glass addr-hero">
      <div class="addr-meta">
        <div class="addr-kicker">Address Book</div>
        <h4 class="addr-title">收货地址</h4>
        <p class="addr-desc">为花束找到最精准的落脚点，常用地址提前维护更省心。</p>
        <div class="addr-pills">
          <span class="addr-pill">共 <span id="addrCount">0</span> 条</span>
          <span class="addr-pill soft" id="defaultStatus">默认地址未设置</span>
        </div>
      </div>
      <div class="addr-hero-actions">
        <button class="pill-btn primary" onclick="openAddrForm()">新增地址</button>
        <button class="pill-btn ghost" onclick="init()">刷新列表</button>
      </div>
    </div>

    <div id="empty" class="empty-state glass mt-3" style="display:none;">
      <div class="empty-title">还没有地址</div>
      <p class="empty-text">添加常用收货地址，让每次下单都一键填充。</p>
      <button class="pill-btn primary" onclick="openAddrForm()">立即新增</button>
    </div>

    <div id="addrList" class="addr-grid mt-3"></div>

    <div class="glass addr-tips mt-3">
      <div class="tip">
        <div class="tip-title">保持手机号畅通</div>
        <p class="tip-text">配送前可能有确认电话，确保号码正确且可接听。</p>
      </div>
      <div class="tip">
        <div class="tip-title">填写清晰地址</div>
        <p class="tip-text">楼栋、门牌、单元号越详细，花艺师送达越快。</p>
      </div>
      <div class="tip">
        <div class="tip-title">默认地址优先使用</div>
        <p class="tip-text">设置默认地址，下单时自动填充，省时又省心。</p>
      </div>
    </div>
  </div>

  <!-- 地址表单模态框 -->
  <div class="modal fade" id="addrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addrModalTitle">新增地址</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addrForm">
            <div class="mb-2">
              <label class="form-label">收货人</label>
              <input name="name" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">手机号</label>
              <input name="phone" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">省/直辖市</label>
              <input name="province" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">市</label>
              <input name="city" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">区/县</label>
              <input name="district" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">详细地址</label>
              <input name="detail" class="form-control" required>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="isDefaultChk">
              <label class="form-check-label" for="isDefaultChk">设为默认地址</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="addrSubmitBtn" onclick="submitAddrForm()">保存</button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/common.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script>
    let addrCache = [];
    let editingId = null;
    let addrModal;
    init();
    async function init(){
      if(!requireAuth({message:'请先登录后管理收货地址'})) return;
      try{
        const res = await httpGet('/api/addresses');
        if(res.code===200){
          addrCache = res.data || [];
          render(addrCache);
        }else{
          render([]);
        }
      }catch(e){ render([]); }
      // 准备模态框实例
      const el = document.getElementById('addrModal');
      if(el) addrModal = new bootstrap.Modal(el);
    }
    function render(list){
      const box = document.getElementById('addrList');
      updateStats(list || []);
      if(!list || list.length===0){
        box.innerHTML = '';
        document.getElementById('empty').style.display = '';
        return;
      }
      document.getElementById('empty').style.display = 'none';
      box.innerHTML = list.map(a=>`
        <div class="addr-card glass">
          <div class="addr-card-head">
            <div>
              <div class="addr-name">${a.name}${a.isDefault===1?'<span class="addr-chip">默认</span>':''}</div>
              <div class="addr-phone">${a.phone}</div>
            </div>
            <div class="addr-actions">
              <button class="btn btn-sm btn-outline-success" onclick="openAddrForm(${a.id})">编辑</button>
              <button class="btn btn-sm btn-outline-danger" onclick="delAddress(${a.id})">删除</button>
            </div>
          </div>
          <div class="addr-line">${a.province}${a.city}${a.district}${a.detail}</div>
          <div class="addr-foot">
            <label class="addr-toggle">
              <input type="checkbox" ${a.isDefault===1?'checked':''} onchange="setDefault(${a.id})">
              <div class="checkmark"></div>
              <span>默认地址</span>
            </label>
          </div>
        </div>
      `).join('');
    }
    function openAddrForm(id){
      editingId = id || null;
      document.getElementById('addrModalTitle').textContent = id ? '编辑地址' : '新增地址';
      // 预填数据
      const form = document.getElementById('addrForm');
      form.reset();
      const cur = id ? addrCache.find(x=>x.id===id) : null;
      form.elements.name.value = cur?.name || '';
      form.elements.phone.value = cur?.phone || '';
      form.elements.province.value = cur?.province || '';
      form.elements.city.value = cur?.city || '';
      form.elements.district.value = cur?.district || '';
      form.elements.detail.value = cur?.detail || '';
      document.getElementById('isDefaultChk').checked = cur ? cur.isDefault===1 : false;
      addrModal?.show();
    }
    async function submitAddrForm(){
      const form = document.getElementById('addrForm');
      if(!form.reportValidity()) return;
      const payload = {
        name: form.elements.name.value.trim(),
        phone: form.elements.phone.value.trim(),
        province: form.elements.province.value.trim(),
        city: form.elements.city.value.trim(),
        district: form.elements.district.value.trim(),
        detail: form.elements.detail.value.trim(),
        isDefault: document.getElementById('isDefaultChk').checked
      };
      let res;
      if(editingId){
        res = await httpPut('/api/addresses/'+editingId, payload);
      }else{
        res = await httpPost('/api/addresses', payload);
      }
      if(res.code===200){ addrModal?.hide(); init(); }
      else { showAlert(res.msg||'保存失败'); }
    }
    async function delAddress(id){
      const ok = await confirmDelete();
      if(!ok) return;
      const res = await httpDelete('/api/addresses/'+id);
      if(res.code===200){ init(); } else { showAlert(res.msg||'删除失败'); }
    }

    function updateStats(list){
      const countEl = document.getElementById('addrCount');
      const defaultEl = document.getElementById('defaultStatus');
      if(countEl) countEl.textContent = list.length || 0;
      if(defaultEl){
        const def = list.find(x=>x.isDefault===1);
        defaultEl.textContent = def ? `默认：${def.name}` : '默认地址未设置';
        defaultEl.classList.toggle('on', !!def);
      }
    }

    function confirmDelete(){
      return new Promise(resolve=>{
        showConfirm('确定删除该地址吗？', {
          title:'删除地址', okText:'删除', cancelText:'保留',
          onOk:()=>resolve(true), onCancel:()=>resolve(false)
        });
      });
    }

    async function setDefault(id){
      const target = addrCache.find(x=>x.id===id);
      if(!target) return;
      if(target.isDefault===1) return; // 已是默认，无需重复请求
      const payload = {
        name: target.name,
        phone: target.phone,
        province: target.province,
        city: target.city,
        district: target.district,
        detail: target.detail,
        isDefault: true
      };
      const res = await httpPut('/api/addresses/'+id, payload);
      if(res.code===200){
        init();
      }else{
        showAlert(res.msg||'设置默认地址失败');
      }
    }

    async function httpPut(url, data){
      const res = await fetch(BASE + url, {method:'PUT', headers: hdr(), body: JSON.stringify(data)});
      return res.json();
    }
  </script>
</body>
</html>