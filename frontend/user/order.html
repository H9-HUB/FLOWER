<!doctype html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <title>订单支付 - Floral Dreams</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/style.css" rel="stylesheet">
    <link href="https://cdn.staticfile.net/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #ff7f50;
            --second: #6a5acd;
        }

        body {
            background: #f8f8f8;
        }

        .card-box {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .1);
            padding: 2rem;
            margin-top: 2rem;
        }

        .btn-gradient {
            background: linear-gradient(135deg, var(--primary), var(--second));
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
        }

        .price {
            font-size: 1.5rem;
            color: var(--primary);
        }
    </style>
</head>

<body>
    <!-- 统一导航由 js/common.js 注入 -->

    <div class="container">
        <div class="card-box">
            <h5>订单支付</h5>
            <div class="mt-3">订单号：<span id="sn" class="text-muted"></span></div>
            <div class="mt-2">应付金额：<span id="amount" class="price"></span></div>
            <div class="mt-4">
                <h6>商品清单</h6>
                <div id="items" class="small text-muted">加载中...</div>
            </div>
            <div class="mt-4">
                <button id="payBtn" class="btn-gradient" onclick="pay()">立即支付</button>
                <button class="btn btn-outline-secondary ms-2" onclick="cancelOrder()">取消订单</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        const id = new URLSearchParams(location.search).get('id');
        let order = {};
        init();
        async function init() {
            if(!requireAuth({message:'请先登录后进行支付与查看订单详情'})) return;
            const res = await httpGet('/api/orders');          // 我的订单列表
            if (res.code !== 200) { alert('请先登录'); location = 'login.html'; return; }
            order = res.data.find(o => o.orderId == id);
            if (!order) { alert('订单不存在'); location = 'list.html'; return; }
            document.getElementById('sn').textContent = order.sn;
            document.getElementById('amount').textContent = '¥' + order.totalAmount.toFixed(2);
            if (order.status !== 'UNPAID') document.getElementById('payBtn').disabled = true;

            // 加载并展示商品条目（仅使用已加载的订单对象，避免额外接口401）
            renderOrderItemsFromOrder();
        }

        function renderOrderItemsFromOrder(){
            const box = document.getElementById('items');
            const items = Array.isArray(order.items) ? order.items : [];
            if(!items.length){ box.textContent = '暂无商品'; return; }
            box.innerHTML = items.map(it=>{
                const price = typeof it.price === 'number' ? it.price.toFixed(2) : (it.price || '—');
                const qty = typeof it.quantity === 'number' ? it.quantity : (it.quantity || '1');
                return `<div>· ${it.flowerName || '商品'} x ${qty}（¥${price}）</div>`;
            }).join('');
        }

        async function pay() {
            if (!confirm('确认支付？')) return;
            const res = await httpPost('/api/orders/' + order.orderId + '/pay', {});
            if (res.code === 200) { alert('支付成功！'); location.href = 'orders.html'; }
            else alert(res.msg);
        }
        async function cancelOrder() {
            if (!confirm('确认取消？')) return;
            const res = await httpPut('/api/orders/' + order.orderId + '/cancel', {});
            if (res.code === 200) { alert('已取消'); location.href = 'list.html'; }
            else alert(res.msg);
        }
    </script>
</body>

</html>