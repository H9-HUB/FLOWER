<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>收货地址 - Floral Dreams</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="css/style.css" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <style>
    .empty{background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:2rem;text-align:center;color:#666}
    .addr-card{padding:1rem}
    /* 使用统一按钮样式，避免与其他界面不一致 */
  </style>
</head>
<body>
  <!-- 统一导航由 js/common.js 注入 -->
  <div class="container mt-4">
    <div class="d-flex align-items-center justify-content-between">
      <h5 class="m-0">收货地址</h5>
      <button class="btn btn-primary" onclick="openAddrForm()">新增地址</button>
    </div>

    <div id="addrList" class="mt-3"></div>

    <div id="empty" class="empty mt-3" style="display:none;">
      还没有地址，点击“新增地址”进行添加。
    </div>
  </div>

  <!-- 地址表单模态框 -->
  <div class="modal fade" id="addrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addrModalTitle">新增地址</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addrForm">
            <div class="mb-2">
              <label class="form-label">收货人</label>
              <input name="name" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">手机号</label>
              <input name="phone" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">省/直辖市</label>
              <input name="province" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">市</label>
              <input name="city" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">区/县</label>
              <input name="district" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">详细地址</label>
              <input name="detail" class="form-control" required>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="isDefaultChk">
              <label class="form-check-label" for="isDefaultChk">设为默认地址</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="addrSubmitBtn" onclick="submitAddrForm()">保存</button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/common.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script>
    let addrCache = [];
    let editingId = null;
    let addrModal;
    init();
    async function init(){
      if(!requireAuth({message:'请先登录后管理收货地址'})) return;
      try{
        const res = await httpGet('/api/addresses');
        if(res.code===200){
          addrCache = res.data || [];
          render(addrCache);
        }else{
          render([]);
        }
      }catch(e){ render([]); }
      // 准备模态框实例
      const el = document.getElementById('addrModal');
      if(el) addrModal = new bootstrap.Modal(el);
    }
    function render(list){
      const box = document.getElementById('addrList');
      if(!list || list.length===0){
        box.innerHTML = '';
        document.getElementById('empty').style.display = '';
        return;
      }
      document.getElementById('empty').style.display = 'none';
      box.innerHTML = list.map(a=>`
        <div class="card addr-card">
          <div><strong>${a.name}</strong> ${a.phone}</div>
          <div class="text-muted mt-1">${a.province}${a.city}${a.district}${a.detail} ${a.isDefault===1?'<span class="badge bg-success">默认</span>':''}</div>
          <div class="mt-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="openAddrForm(${a.id})">编辑</button>
            <button class="btn btn-outline-danger btn-sm" onclick="delAddress(${a.id})">删除</button>
          </div>
        </div>
      `).join('');
    }
    function openAddrForm(id){
      editingId = id || null;
      document.getElementById('addrModalTitle').textContent = id ? '编辑地址' : '新增地址';
      // 预填数据
      const form = document.getElementById('addrForm');
      form.reset();
      const cur = id ? addrCache.find(x=>x.id===id) : null;
      form.elements.name.value = cur?.name || '';
      form.elements.phone.value = cur?.phone || '';
      form.elements.province.value = cur?.province || '';
      form.elements.city.value = cur?.city || '';
      form.elements.district.value = cur?.district || '';
      form.elements.detail.value = cur?.detail || '';
      document.getElementById('isDefaultChk').checked = cur ? cur.isDefault===1 : false;
      addrModal?.show();
    }
    async function submitAddrForm(){
      const form = document.getElementById('addrForm');
      if(!form.reportValidity()) return;
      const payload = {
        name: form.elements.name.value.trim(),
        phone: form.elements.phone.value.trim(),
        province: form.elements.province.value.trim(),
        city: form.elements.city.value.trim(),
        district: form.elements.district.value.trim(),
        detail: form.elements.detail.value.trim(),
        isDefault: document.getElementById('isDefaultChk').checked
      };
      let res;
      if(editingId){
        res = await httpPut('/api/addresses/'+editingId, payload);
      }else{
        res = await httpPost('/api/addresses', payload);
      }
      if(res.code===200){ addrModal?.hide(); init(); }
      else { showAlert(res.msg||'保存失败'); }
    }
    async function delAddress(id){
      if(!confirm('确定删除该地址吗？')) return;
      const res = await httpDelete('/api/addresses/'+id);
      if(res.code===200){ init(); } else { showAlert(res.msg||'删除失败'); }
    }

    async function httpPut(url, data){
      const res = await fetch(BASE + url, {method:'PUT', headers: hdr(), body: JSON.stringify(data)});
      return res.json();
    }
  </script>
</body>
</html>